package uniregistrar.driver.did.sov;

import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.concurrent.ExecutionException;

import org.apache.commons.codec.binary.Base64;
import org.apache.commons.codec.binary.Hex;
import org.hyperledger.indy.sdk.IndyException;
import org.hyperledger.indy.sdk.ledger.Ledger;
import org.hyperledger.indy.sdk.pool.Pool;
import org.hyperledger.indy.sdk.wallet.Wallet;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Taa {

	private static Logger log = LoggerFactory.getLogger(Taa.class);

	public static String getTaa(Pool pool, Wallet wallet, String submitterDid) throws InterruptedException, ExecutionException, IndyException {

		String getTxnAuthorAgreementRequest = Ledger.buildGetTxnAuthorAgreementRequest(submitterDid, null).get();
		String getTxnAuthorAgreementResult = Ledger.signAndSubmitRequest(pool, wallet, submitterDid, getTxnAuthorAgreementRequest).get();
		if (log.isDebugEnabled()) log.debug("getTxnAuthorAgreementResult: (" + getTxnAuthorAgreementResult.length() + ") " + getTxnAuthorAgreementResult);

		JSONObject jsonObjectTAA = new JSONObject(getTxnAuthorAgreementResult);
		JSONObject jsonObjectTAAResult = (jsonObjectTAA.has("result") && jsonObjectTAA.get("result") instanceof JSONObject) ? jsonObjectTAA.getJSONObject("result") : null;
		JSONObject jsonObjectTAAResultData = (jsonObjectTAAResult != null && jsonObjectTAAResult.has("data") && jsonObjectTAAResult.get("data") instanceof JSONObject) ? jsonObjectTAAResult.getJSONObject("data") : null;
		String taa = jsonObjectTAAResultData == null ? null : jsonObjectTAAResultData.getString("text");
		if (log.isDebugEnabled() && taa != null) log.debug("taa: (" + taa.length() + ") " + taa);

		return taa;
	}

	private static final String taa;

	static {

		try {

			taa = new String(Base64.decodeBase64("VHJhbnNhY3Rpb24gQXV0aG9yIEFncmVlbWVudCBWMS4xCgoxCgoMQXBwcm92ZWQgYnkgdGhlIFNvdnJpbiBCb2FyZCBvZiBUcnVzdGVlcyAyMiBNYXkgMjAxOQpUaGlzIFRyYW5zYWN0aW9uIEF1dGhvciBBZ3JlZW1lbnQgKHRoZSDigJzigItBZ3JlZW1lbnTigIvigJ0pIGlzIGVudGVyZWQgaW50byBiZXR3ZWVuIHRoZSBTb3ZyaW4KRm91bmRhdGlvbiwgYSBub25wcm9maXQgY29ycG9yYXRpb24gb3JnYW5pemVkIHVuZGVyIHRoZSBsYXdzIG9mIHRoZSBTdGF0ZSBvZiBVdGFoLCBVbml0ZWQgU3RhdGVzCm9mIEFtZXJpY2EsIGFuZCBfX19fX19fX19fXyAo4oCc4oCLVHJhbnNhY3Rpb24g4oCLQXV0aG9y4oCL4oCdKSwgZWl0aGVyIGEgbmF0dXJhbCBwZXJzb24gYWN0aW5nIGFzIGFuCkluZGl2aWR1YWwgb3IgYSBfX19fX19fX18gb3JnYW5pemVkIHVuZGVyIHRoZSBsYXdzIG9mIF9fX19fX19fXy4gU292cmluIEZvdW5kYXRpb24gYW5kClRyYW5zYWN0aW9uIEF1dGhvciBhcmUgaW5kaXZpZHVhbGx5IHJlZmVycmVkIHRvIGhlcmVpbiBhcyBhIOKAnFBhcnR54oCdIGFuZCBjb2xsZWN0aXZlbHkgYXMgdGhlCuKAnFBhcnRpZXMu4oCdCldIRVJFQVMsIHRoZSBUcmFuc2FjdGlvbiBBdXRob3IgZGVzaXJlcyB0byB3cml0ZSBUcmFuc2FjdGlvbnMgdG8gdGhlIFNvdnJpbiBMZWRnZXI7CldIRVJFQVMsIHRoZSBTb3ZyaW4gRm91bmRhdGlvbiBkZXNpcmVzIHRvIGdyYW50IHBlcm1pc3Npb24gdG8gdGhlIFRyYW5zYWN0aW9uIEF1dGhvciB0bwp3cml0ZSBUcmFuc2FjdGlvbnMgdG8gdGhlIFNvdnJpbiBMZWRnZXI7CldIRVJFQVMsIHN1YmplY3QgdG8gdGhlIFRyYW5zYWN0aW9uIEF1dGhvciBjb21wbHlpbmcgd2l0aCB0aGUgdGVybXMgYW5kIGNvbmRpdGlvbnMgb2YgdGhpcwpBZ3JlZW1lbnQsIHRoZSBTb3ZyaW4gRm91bmRhdGlvbiBncmFudHMgcGVybWlzc2lvbiB0byB0aGUgVHJhbnNhY3Rpb24gQXV0aG9yIHRvIHdyaXRlClRyYW5zYWN0aW9ucyB0byB0aGUgU292cmluIExlZGdlcjsKV0hFUkVBUywgc3ViamVjdCB0byB0aGUgVHJhbnNhY3Rpb24gQXV0aG9yIGNvbXBseWluZyB3aXRoIHRoZSB0ZXJtcyBhbmQgY29uZGl0aW9ucyBvZiB0aGlzCkFncmVlbWVudCwgdGhlIFRyYW5zYWN0aW9uIEF1dGhvciBhY2NlcHRzIHBlcm1pc3Npb24gZnJvbSB0aGUgU292cmluIEZvdW5kYXRpb24gdG8gd3JpdGUKVHJhbnNhY3Rpb25zIHRvIHRoZSBTb3ZyaW4gTGVkZ2VyOwpGT1IgR09PRCBBTkQgVkFMVUFCTEUgQ09OU0lERVJBVElPTiwgVEhFIFNVRkZJQ0lFTkNZIE9GIFdISUNIIElTIEhFUkVCWQpBQ0tOT1dMRURHRUQsIFRIRSBQQVJUSUVTIEFHUkVFIEFTIEZPTExPV1M6CgoxKSBEZWZpbml0aW9ucwpVbmxlc3Mgb3RoZXJ3aXNlIGRlZmluZWQgYWJvdmUsIGFsbCBjYXBpdGFsaXplZCB0ZXJtcyB1c2VkIGluIHRoaXMgQWdyZWVtZW50IHNoYWxsIGhhdmUgdGhlCm1lYW5pbmdzIGdpdmVuIHRvIHRoZW0gaW4gdGhpcyBBZ3JlZW1lbnQgb3IgaW4gdGhlIOKAi1NvdnJpbiBHb3Zlcm5hbmNlIEZyYW1ld29yayBhbmQKY29ycmVzcG9uZGluZyDigItTb3ZyaW4gR2xvc3NhcnnigIsuIFRoZSBTb3ZyaW4gR292ZXJuYW5jZSBGcmFtZXdvcmsgYW5kIFNvdnJpbiBHbG9zc2FyeSBpcwppbmNvcnBvcmF0ZWQgaW50byB0aGlzIEFncmVlbWVudCBieSByZWZlcmVuY2Ugb25seSBmb3IgcHVycG9zZXMgb2YgdXNlIG9mIHN1Y2ggZGVmaW5lZAp0ZXJtcy4KCjIpIFBlcm1pc3Npb24gdG8gV3JpdGUgdG8gdGhlIFNvdnJpbiBMZWRnZXIKYS4gVGhlIFNvdnJpbiBGb3VuZGF0aW9uIGdyYW50cyB0byB0aGUgVHJhbnNhY3Rpb24gQXV0aG9yIHRoZSByZXZvY2FibGUgcmlnaHQgdG8gd3JpdGUgdG8KdGhlIFNvdnJpbiBMZWRnZXIgcHJvdmlkZWQgdGhhdCB0aGUgVHJhbnNhY3Rpb24gQXV0aG9yIHJlbWFpbnMgaW4gY29tcGxpYW5jZSB3aXRoIGFsbCBvZgppdHMgb2JsaWdhdGlvbnMgdW5kZXIgdGhpcyBBZ3JlZW1lbnQuCmIuIFdoZW4gYXV0aG9yaW5nIHRyYW5zYWN0aW9ucyB1bmRlciB0aGUgcG9saWN5IG9mIFBlcm1pc3Npb25lZCBXcml0ZSBBY2Nlc3MsIGEKVHJhbnNhY3Rpb24gQXV0aG9yIG1heSBvbmx5IHdyaXRlIHRvIHRoZSBTb3ZyaW4gTGVkZ2VyIGJ5IHVzaW5nIGFuIGF1dGhvcml6ZWQKCjIKCgxUcmFuc2FjdGlvbiBFbmRvcnNlci4gSW4gdGhlIGV2ZW50IHRoYXQgU292cmluIEZvdW5kYXRpb24gZW5hYmxlcyBQdWJsaWMgV3JpdGUgQWNjZXNzCnRvIHRoZSBTb3ZyaW4gTGVkZ2VyLCB0aGUgVHJhbnNhY3Rpb24gQXV0aG9yIHdpbGwgbm90IG5lZWQgYSBUcmFuc2FjdGlvbiBFbmRvcnNlciB0bwplbmRvcnNlIGEgVHJhbnNhY3Rpb24uCmMuIE9uY2UgYW4gaW5pdGlhbCBUcmFuc2FjdGlvbiBoYXMgYmVlbiB3cml0dGVuIHRvIHRoZSBTb3ZyaW4gTGVkZ2VyIGJ5IHRoZSBUcmFuc2FjdGlvbgpBdXRob3IgKOKAnEluaXRpYWwgVHJhbnNhY3Rpb27igJ0pLCB0aGUgVHJhbnNhY3Rpb24gQXV0aG9yIGlzIGdyYW50ZWQgcGVybWlzc2lvbiB0byBtYWtlCmFkZGl0aW9uYWwgVHJhbnNhY3Rpb25zIHRvIHVwZGF0ZSB0aGUgc3RhdGUgb2YgYSBwcmV2aW91cyBUcmFuc2FjdGlvbiAo4oCcVXBkYXRlClRyYW5zYWN0aW9uc+KAnSkuIEEgVHJhbnNhY3Rpb24gQXV0aG9yIG1heSBtYWtlIFVwZGF0ZSBUcmFuc2FjdGlvbnMgaWYgYW5kIG9ubHkgaWYgdGhlClRyYW5zYWN0aW9uIEF1dGhvciB3YXMgdGhlIEF1dGhvciBvZiB0aGUgSW5pdGlhbCBUcmFuc2FjdGlvbi4gVXBkYXRlIFRyYW5zYWN0aW9ucyBhcmUKVHJhbnNhY3Rpb25zIGFuZCBhcmUgc3ViamVjdCB0byBhbGwgdGhlIHRlcm1zIG9mIHRoaXMgQWdyZWVtZW50LgoKMykgVHJhbnNhY3Rpb24gQXV0aG9yIE9ibGlnYXRpb25zCmEuIFdpdGggcmVnYXJkIHRvIGFsbCBUcmFuc2FjdGlvbnMgd3JpdHRlbiBieSBvciBvbiBiZWhhbGYgb2YgdGhlIFRyYW5zYWN0aW9uIEF1dGhvciB0byB0aGUKU292cmluIExlZGdlciAo4oCc4oCLQXV0aG9yZWQgVHJhbnNhY3Rpb25z4oCL4oCdKSwgdGhlIFRyYW5zYWN0aW9uIEF1dGhvciByZXByZXNlbnRzIGFuZAp3YXJyYW50cyB0aGF0OgoxLiBpdCBoYXMgYWxsIG5lY2Vzc2FyeSByaWdodHMgYW5kIHBlcm1pc3Npb25zIHRvIHdyaXRlIHRoZSBBdXRob3JlZCBUcmFuc2FjdGlvbnM7CjIuIHRoZSBBdXRob3JlZCBUcmFuc2FjdGlvbnMgZG8gbm90IGFuZCB3aWxsIG5vdCB2aW9sYXRlIGFueSBhcHBsaWNhYmxlIGxhdzsKMy4gdGhlIEF1dGhvcmVkIFRyYW5zYWN0aW9ucyB3aWxsIG5vdCBjb250YWluIGRhdGEgb3IgaW5mb3JtYXRpb24gdGhhdCBpbmZyaW5nZXMgb3IKbWlzYXBwcm9wcmlhdGVzIHRoZSBpbnRlbGxlY3R1YWwgcHJvcGVydHkgcmlnaHRzIG9mIGFueSB0aGlyZCBwYXJ0eTsKNC4gaXQgd2lsbCBjb21wbHkgd2l0aCBhbnkgcmVxdWlyZW1lbnRzIGltcG9zZWQgYnkgdGhlIFRyYW5zYWN0aW9uIEVuZG9yc2VyIG9uIHRoZQpUcmFuc2FjdGlvbiBBdXRob3IgYW5kIGFueSBBdXRob3JlZCBUcmFuc2FjdGlvbnMgZW5kb3JzZWQgYnkgdGhlIFRyYW5zYWN0aW9uCkVuZG9yc2VyOwo1LiBpdCB3aWxsIG5vdCBhdXRob3IgVHJhbnNhY3Rpb25zIGNvbnRhaW5pbmcgUGVyc29uYWwgRGF0YSBhcyB0aGF0IHRlcm0gaXMgZGVmaW5lZCBpbgp0aGUgRXVyb3BlYW4gVW5pb27igJlzIEdlbmVyYWwgRGF0YSBQcm90ZWN0aW9uIFJlZ3VsYXRpb24gKOKAnOKAi0dEUFLigIvigJ0pLCBleGNlcHQ6CmkuCkluIHRoZSBldmVudCB0aGF0IFNvdnJpbiBGb3VuZGF0aW9uIHBlcm1pdHMgQXV0aG9yZWQgVHJhbnNhY3Rpb25zIHRvCmNvbnRhaW4gUGVyc29uYWwgRGF0YSwgdGhlbiB0aGUgVHJhbnNhY3Rpb24gQXV0aG9yIHJlcHJlc2VudHMgYW5kCndhcnJhbnRzIHRoYXQ6CkEuIGl0IGhhcyByZWNlaXZlZCBleHByZXNzLCB3cml0dGVuIGNvbnNlbnQsIGluIHRoZSBmb3JtIHJlcXVpcmVkIGJ5IGFsbAphcHBsaWNhYmxlIGxhd3MsIGZvciB0aGUgUGVyc29uYWwgRGF0YSB0byBiZSBwZXJtYW5lbnRseSBzdG9yZWQKb24gdGhlIFNvdnJpbiBMZWRnZXIgcHJpb3IgdG8gd3JpdGluZyBzdWNoIFBlcnNvbmFsIERhdGEgdG8gdGhlClNvdnJpbiBMZWRnZXI7CkIuIHRoZSBjb25zZW50IGluY2x1ZGVzIGEgcHJvdmlzaW9uIHRoYXQgcGVybWl0cyB0aGUgRGF0YSBTdWJqZWN0IHRvCndpdGhkcmF3IGl0cyBjb25zZW50IG9yIGV4ZXJjaXNlIGl0cyByaWdodCB0byBiZSBmb3Jnb3R0ZW4gcHVyc3VhbnQKdG8gYXBwbGljYWJsZSBsYXc7IGFuZApDLiBpZiB0aGUgRGF0YSBTdWJqZWN0IHdobyBwcm92aWRlZCBleHByZXNzLCB3cml0dGVuIGNvbnNlbnQgZm9yIHRoZQpzdG9yYWdlIG9mIFBlcnNvbmFsIERhdGEgb24gdGhlIFNvdnJpbiBMZWRnZXIgd2l0aGRyYXdzIGl0cwpjb25zZW50IG9yIGlmIHRoZSBEYXRhIFN1YmplY3QgZXhlcmNpc2VzIGEgcmlnaHQgdG8gYmUgZm9yZ290dGVuLCB0aGUKd2l0aGRyYXduIGNvbnNlbnQgYW5kIHJpZ2h0IHRvIGJlIGZvcmdvdHRlbiByZXF1ZXN0IHdpbGwgYmUKZWZmZWN0dWF0ZWQgYnkgbWFya2luZyB0aGUgYXBwbGljYWJsZSBUcmFuc2FjdGlvbihzKSB3aXRoIGEKVG9tYnN0b25lIChpZiBzdWNoIGZ1bmN0aW9uYWxpdHkgaXMgZW5hYmxlZCBvbiB0aGUgU292cmluIExlZGdlcikKYW5kIHRoYXQgc3VjaCBtYXJraW5nIHdpbGwgZnVsbHkgc2F0aXNmeSB0aGUgd2l0aGRyYXduIGNvbnNlbnQKYW5kL29yIHJpZ2h0IHRvIGJlIGZvcmdvdHRlbiByZXF1ZXN0LCBhcyBhcHBsaWNhYmxlLgo2LiB0aGUgVHJhbnNhY3Rpb24gQXV0aG9yIHNoYWxsIG1haW50YWluIHN1Y2ggd3JpdHRlbiBjb25zZW50cyAocmVmZXJlbmNlZCBpbgoKMwoKDFNlY3Rpb24gMyhhKSg1KSkgZm9yIGEgcGVyaW9kIG9mIHNldmVuICg3KSB5ZWFycyB0aGVyZWFmdGVyLgpiLiBUcmFuc2FjdGlvbiBBdXRob3IgbWF5IHJlcXVlc3QgdGhhdCBhIFN0ZXdhcmQgbWFyayBhIFRyYW5zYWN0aW9uIGFzIGEgTm9kZS1TcGVjaWZpYwpUb21ic3RvbmUgKGlmIHN1Y2ggZnVuY3Rpb25hbGl0eSBpcyBlbmFibGVkIG9uIHRoZSBTb3ZyaW4gTGVkZ2VyKSBpZiBpdCBpcyBpbnZva2luZyBhIERhdGEKU3ViamVjdOKAmXMgcmlnaHQgdG8gZXJhc3VyZSBvZiBQZXJzb25hbCBEYXRhLgoKNAoKDDQpIEdvdmVybmluZyBMYXcgYW5kIEZvcnVtClRoaXMgQWdyZWVtZW50IGlzIGdvdmVybmVkIGJ5IHRoZSBsYXcgb2YgdGhlIFN0YXRlIG9mIERlbGF3YXJlLCB3aXRob3V0IHJlZmVyZW5jZSB0bwpjb25mbGljdCBvZiBsYXdzIHByaW5jaXBsZXMuIEFsbCBkaXNwdXRlcyBhcmlzaW5nIG91dCBvZiBvciBpbiBjb25uZWN0aW9uIHdpdGggdGhpcyBBZ3JlZW1lbnQKc2hhbGwgYmUgZmluYWxseSBzZXR0bGVkIGJ5IGJpbmRpbmcgYXJiaXRyYXRpb24gdW5kZXIgdGhlIFJ1bGVzIG9mIEFyYml0cmF0aW9uIG9mIHRoZSBJbnRlcm5hdGlvbmFsCkNoYW1iZXIgb2YgQ29tbWVyY2UgYnkgYSBzaW5nbGUgYXJiaXRyYXRvciBhcHBvaW50ZWQgaW4gYWNjb3JkYW5jZSB3aXRoIHRoZSBzYWlkIFJ1bGVzLgpVbmxlc3MgdGhlIFBhcnRpZXMgb3RoZXJ3aXNlIG11dHVhbGx5IGFncmVlLCBzdWNoIGFyYml0cmF0aW9uIHNoYWxsIGJlIGNvbmR1Y3RlZCBpbiB0aGUKRW5nbGlzaCBsYW5ndWFnZSBieSBlbGVjdHJvbmljIGV4Y2hhbmdlIG9mIGRvY3VtZW50cyBhbmQgYnkgdmlkZW9jb25mZXJlbmNlLiBUaGUKYXJiaXRyYXRvciBzaGFsbCBpc3N1ZSBhIHJlYXNvbmVkIGRlY2lzaW9uLCBpbmNsdWRpbmcgZmluZGluZ3Mgb2YgZmFjdCBhbmQgY29uY2x1c2lvbnMgb2YgbGF3LgpUaGUgYXJiaXRyYXRvciBzaGFsbCByZXF1aXJlIGV4Y2hhbmdlIGJ5IHRoZSBQYXJ0aWVzIG9mIGRvY3VtZW50cyByZWxldmFudCB0byB0aGUgaXNzdWVzCnJhaXNlZCBieSBhbnkgY2xhaW0sIGRlZmVuc2UsIG9yIGNvdW50ZXJjbGFpbSBvciBvbiB3aGljaCB0aGUgcHJvZHVjaW5nIFBhcnR5IG1heSByZWx5IGluCnN1cHBvcnQgb2Ygb3IgaW4gb3Bwb3NpdGlvbiB0byBhbnkgY2xhaW0sIGRlZmVuc2UsIG9yIGNvdW50ZXJjbGFpbSwgd2l0aCBkdWUgcmVnYXJkIGZvcgplbGltaW5hdGluZyB1bmR1ZSBidXJkZW4gYW5kIGV4cGVuc2UgYW5kIHRoZSBleHBlZGl0ZWQgYW5kIGxvd2VyIGNvc3QgbmF0dXJlIG9mCmFyYml0cmF0aW9uLiBBdCB0aGUgcmVxdWVzdCBvZiBhIFBhcnR5LCB0aGUgYXJiaXRyYXRvciBtYXkgYXQgaGlzIG9yIGhlciBkaXNjcmV0aW9uIG9yZGVyIHRoZQpkZXBvc2l0aW9uIG9mIHdpdG5lc3Nlcy4gRGVwb3NpdGlvbnMgc2hhbGwgYmUgbGltaXRlZCB0byBhIG1heGltdW0gb2YgdGhyZWUgZGVwb3NpdGlvbnMgcGVyClBhcnR5LCBlYWNoIG9mIGEgbWF4aW11bSBvZiBmb3VyIGhvdXJzIGR1cmF0aW9uLCB1bmxlc3MgdGhlIGFyYml0cmF0b3Igb3RoZXJ3aXNlIGRldGVybWluZXMuCkRlbWFuZCBmb3IgYXJiaXRyYXRpb24gbWF5IGJlIGluaXRpYXRlZCBieSBlaXRoZXIgUGFydHkgb24gZmlmdGVlbiAoMTUpIGRheXMgd3JpdHRlbiBub3RpY2UgYnkKZW1haWwgdG8gdGhlIG90aGVyIFBhcnR54oCZcyBkZXNpZ25hdGVkIHJlcHJlc2VudGF0aXZlLCB0b2dldGhlciB3aXRoIGEgd3JpdHRlbiBzcGVjaWZpY2F0aW9uIG9mCnRoZSBncm91bmRzIGZvciB0aGUgZGlzcHV0ZSBhbmQgdGhlIHJlbGllZiByZXF1ZXN0ZWQuIEJ5IGFncmVlaW5nIHRvIGJpbmRpbmcgYW5kCm5vbi1hcHBlYWxhYmxlIGFyYml0cmF0aW9uLCBlYWNoIHBhcnR5IHVuZGVyc3RhbmRzIHRoYXQgdGhleSBlYWNoIGZvcmV2ZXIgZ2l2ZSB1cCBhbmQgd2FpdmUKYW55IHJpZ2h0IHdoaWNoIGVhY2ggUGFydHkgbWF5IGhhdmUgdG8gcmVzb2x2ZSBhbnkgc3VjaCBjbGFpbSwgZGlmZmVyZW5jZSBvciBkaXNwdXRlIGJ5CmNvdXJ0IG9yIGp1cnkgdHJpYWwuIE5vdHdpdGhzdGFuZGluZyB0aGUgZm9yZWdvaW5nLCBlaXRoZXIgUGFydHkgbWF5IGJyaW5nIGEgcHJvY2VlZGluZwpzZWVraW5nIGVxdWl0YWJsZSBvciBpbmp1bmN0aXZlIHJlbGllZiBzb2xlbHkgYW5kIGV4Y2x1c2l2ZWx5IGluIHRoZSBzdGF0ZSBhbmQgZmVkZXJhbCBjb3VydHMKbG9jYXRlZCBpbiBXaWxtaW5ndG9uLCBEZWxhd2FyZSwgdG8gcHJldmVudCB0aGUgaW5mcmluZ2VtZW50IG9mIGludGVsbGVjdHVhbCBwcm9wZXJ0eSByaWdodHMgb3IKdGhlIGRpc2Nsb3N1cmUgb2YgY29uZmlkZW50aWFsIGluZm9ybWF0aW9uLiBFYWNoIFBhcnR5IGhlcmV0byBjb25zZW50cyB0byB0aGUgZXhjbHVzaXZlCmp1cmlzZGljdGlvbiBvZiBzdWNoIGNvdXJ0cyBmb3IgdGhlIGFkanVkaWNhdGlvbiBvZiBhbnkgc3VjaCBlcXVpdGFibGUgb3IgaW5qdW5jdGl2ZSByZWxpZWYsIGFzCndlbGwgYXMgZm9yIGFueSBzdWNoIG1hdHRlcnMgdGhhdCBhcmUgZXhjbHVkZWQgZnJvbSBvciBmYWxsIG91dHNpZGUgb2YgdGhpcyBhcmJpdHJhdGlvbgpwcm92aXNpb24uCgo1KSBSZXByZXNlbnRhdGlvbnMgYW5kIFdhcnJhbnRpZXM7IERpc2NsYWltZXIKYS4gQnkgU292cmluIEZvdW5kYXRpb27igIsuCjEuIFNPVlJJTiBGT1VOREFUSU9OIE1BS0VTIE5PIFdBUlJBTlRZIENPTkNFUk5JTkcgVEhFCkFDQ1VSQUNZLCBSRUxJQUJJTElUWSwgT1IgQ09NUExFVEVORVNTIE9GIEFOWSBJTkZPUk1BVElPTiBPUgpEQVRBIE9CVEFJTkVEIE9SIERFUklWRUQgVEhST1VHSCBUSEUgVVNFIE9GIFRIRSBTT1ZSSU4gTEVER0VSLApBTkQgRElTQ0xBSU1TIEFOWSBPVEhFUiBSRVBSRVNFTlRBVElPTlMgT1IgV0FSUkFOVElFUywKRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgV0lUSE9VVCBMSU1JVEFUSU9OLCBBTlkgV0FSUkFOVElFUwpPRiBNRVJDSEFOVEFCSUxJVFkgT1IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UsCk5PTi1JTkZSSU5HRU1FTlQsIEFDQ1VSQUNZIE9SIENPTVBMRVRFTkVTUyBPRiBEQVRBLgpiLiBCeSBUcmFuc2FjdGlvbiBBdXRob3IuCjEuIFRyYW5zYWN0aW9uIEF1dGhvciByZXByZXNlbnRzIHRoYXQgaXQgdW5kZXJzdGFuZHMgdGhhdCB0aGUgU292cmluIExlZGdlciBvcGVyYXRlcyBvbgphIGRpc3RyaWJ1dGVkIG5ldHdvcmsgYW5kIHRoYXQgU292cmluIEZvdW5kYXRpb24gZGlzY2xhaW1zIGFueSByZXNwb25zaWJpbGl0aWVzIHdpdGgKCjUKCgxyZXNwZWN0IHRvIGFjY2VzcyBvZiBkYXRhIGZyb20gdGhlIFNvdnJpbiBMZWRnZXIuCjIuIFRyYW5zYWN0aW9uIEF1dGhvciByZXByZXNlbnRzIHRoYXQgaXQgdW5kZXJzdGFuZHMgYW5kIGFja25vd2xlZGdlcyB0aGF0IFNvdnJpbgpGb3VuZGF0aW9uIGRvZXMgbm90IGNvbnRyb2wgdGhlIHRyYW5zZmVyIG9mIGRhdGEgYmV0d2VlbiBOb2RlcyBhbmQgb3Zlcgpjb21tdW5pY2F0aW9ucyBmYWNpbGl0aWVzLCBpbmNsdWRpbmcgdGhlIGludGVybmV0LCBhbmQgdGhhdCB0aGUgU292cmluIExlZGdlciBtYXkgYmUKc3ViamVjdCB0byBsaW1pdGF0aW9ucywgZGVsYXlzLCBhbmQgb3RoZXIgcHJvYmxlbXMgaW5oZXJlbnQgaW4gdGhlIHVzZSBvZiBzdWNoCmNvbW11bmljYXRpb25zIGZhY2lsaXRpZXMuCjMuIFRyYW5zYWN0aW9uIEF1dGhvciByZXByZXNlbnRzIHRoYXQgaXQgdW5kZXJzdGFuZHMgYW5kIGFja25vd2xlZGdlcyB0aGF0IHRoZXJlIGlzCnJlZ3VsYXRvcnkgdW5jZXJ0YWludHkgcmVnYXJkaW5nIHRoZSBTb3ZyaW4gTGVkZ2Vy4oCZcyBjb21wbGlhbmNlIHdpdGggR0RQUiBhcyBpdApyZWxhdGVzIHRvIFBlcm1pc3Npb25lZCBXcml0ZSBBY2Nlc3MsIFB1YmxpYyBXcml0ZSBBY2Nlc3MsIGFuZCBQZXJzb25hbCBEYXRhLAppbmNsdWRpbmcgYXMgaXQgcmVsYXRlcyB0byBjcm9zcy1ib3JkZXIgdHJhbnNmZXJzIG9mIGRhdGEsIHJlc3RyaWN0aW9ucyBvZiBwcm9jZXNzaW5nCmRhdGEsIHRoZSByaWdodCB0byBlZmZlY3RpdmUgZXJhc3VyZSBvZiBkYXRhLCBhcyB3ZWxsIGFzIHRoZSBzY29wZSBhbmQgbmF0dXJlIG9mClBlcnNvbmFsIERhdGEgaXRzZWxmLiBUcmFuc2FjdGlvbiBBdXRob3IgZnVydGhlciByZXByZXNlbnRzIHRoYXQgaXQgdW5kZXJzdGFuZHMgYW5kCmFja25vd2xlZGdlcyB0aGF0IFNvdnJpbiBGb3VuZGF0aW9uIG1heSBtb2RpZnksIGF0IGFueSB0aW1lLCBpdHMgU292cmluIExlZGdlcgpBY2Nlc3MgUG9saWNpZXMgYW5kIHRoZSB0ZXJtcyBvZiB0aGlzIEFncmVlbWVudCBhbmQgYW55IG90aGVyIGFncmVlbWVudCBvcgpkb2N1bWVudCByZWxhdGVkIHRvIHRoZSBTb3ZyaW4gTGVkZ2VyIGJhc2VkIG9uIG5ldyBpbmZvcm1hdGlvbiwgZ3VpZGFuY2UsIG9yIGxhdwpyZWxhdGVkIHRvIEdEUFIgY29tcGxpYW5jZS4KNC4gVHJhbnNhY3Rpb24gQXV0aG9yIHJlcHJlc2VudHMgdGhhdCBpdCB1bmRlcnN0YW5kcyBhbmQgYWNrbm93bGVkZ2VzIHRoYXQgYSBTdGV3YXJkCmhhcyBkaXNjcmV0aW9uIHRvIG1hcmsgYSBUcmFuc2FjdGlvbiBhcyBhIE5vZGUtU3BlY2lmaWMgVG9tYnN0b25lIChpZiBzdWNoCmZ1bmN0aW9uYWxpdHkgaXMgZW5hYmxlZCBvbiB0aGUgU292cmluIExlZGdlcikgaWYgKGkpIHRoZSBUcmFuc2FjdGlvbiBBdXRob3IgbWFrZXMgYQpyZXF1ZXN0IHB1cnN1YW50IHRvIFNlY3Rpb24gMyhiKTsgKGlpKSB0aGUgU3Rld2FyZCBvciBTb3ZyaW4gRm91bmRhdGlvbiBpcyByZXF1aXJlZCB0bwpkbyBzbyBieSBhIGNvdXJ0IG9yZGVyOyAoaWlpKSBvciBpZiB0aGUgU3Rld2FyZCBvciBTb3ZyaW4gRm91bmRhdGlvbiBoYXMgZXZpZGVuY2UgdGhhdAp0aGUgVHJhbnNhY3Rpb24gdmlvbGF0ZXMgdGhlIHRlcm1zIG9mIHRoaXMgQWdyZWVtZW50LgoKNikgTGltaXRhdGlvbiBvZiBMaWFiaWxpdHkKRVhDRVBUIElOIFRIRSBFVkVOVCBPRiBFSVRIRVIgUEFSVFnigJlTIEdST1NTIE5FR0xJR0VOQ0UsIFdJTExGVUwKTUlTQ09ORFVDVCBPUiBGUkFVRCwgSU4gTk8gRVZFTlQgU0hBTEwgRUlUSEVSIFBBUlRZIEJFIExJQUJMRSBGT1IgQU5ZCklORElSRUNULApJTkNJREVOVEFMLApFWEVNUExBUlksClBVTklUSVZFLApTUEVDSUFMLCBPUiBPVEhFUgpDT05TRVFVRU5USUFMIERBTUFHRVMgVU5ERVIgVEhJUyBBR1JFRU1FTlQsIElOQ0xVRElORywgV0lUSE9VVApMSU1JVEFUSU9OLCBBTlkgTE9TVCBQUk9GSVRTLCBCVVNJTkVTUyBJTlRFUlJVUFRJT04sIExPU1MgT0YgUFJPR1JBTVMKT1IgREFUQSwgT1IgT1RIRVJXSVNFLCBFVkVOIElGIFRIRSBPVEhFUiBQQVJUWSBJUyBFWFBSRVNTTFkgQURWSVNFRCBPRgpUSEUgUE9TU0lCSUxJVFkgT1IgTElLRUxJSE9PRCBPRiBTVUNIIERBTUFHRVMuCkVYQ0VQVCBJTiBUSEUgRVZFTlQgT0YgRUlUSEVSIFBBUlRZ4oCZUyBHUk9TUyBORUdMSUdFTkNFLCBXSUxMRlVMCk1JU0NPTkRVQ1QgT1IgRlJBVUQsIElOIE5PIEVWRU5UIFNIQUxMIEVJVEhFUiBQQVJUWeKAmVMgTElBQklMSVRZIFVOREVSClRISVMgQUdSRUVNRU5UIEVYQ0VFRCAkMjUwLDAwMCBVU0QgSU4gVEhFIEFHR1JFR0FURS4gSU4gVEhFIEVWRU5UIE9GCkVJVEhFUiBQQVJUWeKAmVMgR1JPU1MgTkVHTElHRU5DRSwgU1VDSCBQQVJUWeKAmVMgTElBQklMSVRZIFVOREVSIFRISVMKQUdSRUVNRU5UIFNIQUxMIE5PVCBFWENFRUQgJDUwMCwwMDAgVVNEIElOIFRIRSBBR0dSRUdBVEUuIElOIFRIRQpFVkVOVCBPRiBFSVRIRVIgUEFSVFnigJlTIFdJTExGVUwgTUlTQ09ORFVDVCBPUiBGUkFVRCwgVEhFUkUgU0hBTEwgQkUKTk8gRE9MTEFSIENBUCBPTiBTVUNIIFBBUlRZ4oCZUyBMSUFCSUxJVFkgVU5ERVIgVEhJUyBBR1JFRU1FTlQuCgo3KSBNaXNjZWxsYW5lb3VzCmEuIE5vdGljZeKAiy4gQW55IG5vdGljZSwgcGF5bWVudCwgZGVtYW5kIG9yIGNvbW11bmljYXRpb24gcmVxdWlyZWQgb3IgcGVybWl0dGVkIHRvIGJlCgo2CgoMYi4KCmMuCgpkLgoKZS4KCmYuCgpnLgoKaC4KCmkuCgo3CgpkZWxpdmVyZWQgb3IgZ2l2ZW4gYnkgdGhlIHByb3Zpc2lvbnMgb2YgdGhpcyBBZ3JlZW1lbnQgc2hhbGwgYmUgZGVlbWVkIHRvIGhhdmUgYmVlbgplZmZlY3RpdmVseSBkZWxpdmVyZWQgb3IgZ2l2ZW4gYW5kIHJlY2VpdmVkIG9uIHRoZSBkYXRlIHBlcnNvbmFsbHkgb3IgZWxlY3Ryb25pY2FsbHkKZGVsaXZlcmVkIHRvIHRoZSByZXNwZWN0aXZlIFBhcnR5IHRvIHdob20gaXQgaXMgZGlyZWN0ZWQsIG9yIHdoZW4gZGVwb3NpdGVkIGJ5IHJlZ2lzdGVyZWQKb3IgY2VydGlmaWVkIG1haWwsIHdpdGggcG9zdGFnZSBhbmQgY2hhcmdlcyBwcmVwYWlkIGFuZCBhZGRyZXNzZWQgdG8gdGhlIFBhcnRpZXMgYXQgdGhlCmFkZHJlc3NlcyBzZXQgZm9ydGggYmVsb3cgb3Bwb3NpdGUgdGhlaXIgc2lnbmF0dXJlcyB0byB0aGlzIEFncmVlbWVudC4KU2V2ZXJhYmlsaXR54oCLLiBJZiBhbnkgcHJvdmlzaW9uIG9mIHRoaXMgQWdyZWVtZW50IGlzIGhlbGQgaW52YWxpZCwgaWxsZWdhbCwgb3IgdW5lbmZvcmNlYWJsZSwKdGhlIHZhbGlkaXR5LCBsZWdhbGl0eSwgYW5kIGVuZm9yY2VhYmlsaXR5IG9mIGFueSBvZiB0aGUgcmVtYWluaW5nIHByb3Zpc2lvbnMgb2YgdGhpcwpBZ3JlZW1lbnQgc2hhbGwgbm90IGluIGFueSB3YXkgYmUgYWZmZWN0ZWQgb3IgaW1wYWlyZWQuClJlbGF0aW9uc2hpcCBvZiB0aGUgUGFydGllc+KAiy4gVGhpcyBBZ3JlZW1lbnQgZG9lcyBub3QgY3JlYXRlIGEgcGFydG5lcnNoaXAsIGZyYW5jaGlzZSwKam9pbnQgdmVudHVyZSwgYWdlbmN5LCBmaWR1Y2lhcnkgb3IgZW1wbG95bWVudCByZWxhdGlvbnNoaXAgYmV0d2VlbiB0aGUgUGFydGllcy4gTmVpdGhlcgpQYXJ0eSB3aWxsIHJlcHJlc2VudCB0aGF0IGl0IGhhcyBhbnkgYXV0aG9yaXR5IHRvIGFzc3VtZSBvciBjcmVhdGUgYW55IG9ibGlnYXRpb24sIGV4cHJlc3MKb3IgaW1wbGllZCwgb24gYmVoYWxmIG9mIHRoZSBvdGhlciBQYXJ0eSwgbm9yIHRvIHJlcHJlc2VudCB0aGUgb3RoZXIgUGFydHkgYXMgYWdlbnQsCmVtcGxveWVlLCBmcmFuY2hpc2VlLCBvciBpbiBhbnkgb3RoZXIgY2FwYWNpdHkuIFRoZXJlIGFyZSBubyB0aGlyZC1wYXJ0eSBiZW5lZmljaWFyaWVzIHRvCnRoaXMgQWdyZWVtZW50LiBOZWl0aGVyIFBhcnR5IHNoYWxsIG1ha2UgYW55IHByb3Bvc2FscywgcHJvbWlzZXMsIHdhcnJhbnRpZXMsCmd1YXJhbnRlZXMsIG9yIHJlcHJlc2VudGF0aW9ucyBvbiBiZWhhbGYgb2YgdGhlIG90aGVyIFBhcnR5IG9yIGluIHRoZSBvdGhlciBQYXJ0eeKAmXMgbmFtZS4KQXNzaWdubWVudOKAiy4gTmVpdGhlciBQYXJ0eSB3aWxsIHZvbHVudGFyaWx5LCBvciBieSBvcGVyYXRpb24gb2YgbGF3LCBhc3NpZ24gb3Igb3RoZXJ3aXNlCnRyYW5zZmVyIHRoaXMgQWdyZWVtZW50IHdpdGhvdXQgdGhlIG90aGVyIFBhcnR54oCZcyBleHByZXNzIHByaW9yIHdyaXR0ZW4gY29uc2VudCB3aGljaCB3aWxsCm5vdCBiZSB1bnJlYXNvbmFibHkgd2l0aGhlbGQsIHByb3ZpZGVkIHRoYXQgbm8gc3VjaCBjb25zZW50IGlzIHJlcXVpcmVkIGZvciBhbgphc3NpZ25tZW50IG9yIHRyYW5zZmVyIHRvIGEgd2hvbGx5IG9yIG1ham9yaXR5IG93bmVkIHN1YnNpZGlhcnkgb3IgdG8gYSBzdWNjZXNzb3IgaW4KaW50ZXJlc3QgYnkgcmVhc29uIG9mIG1lcmdlciBvciBjb25zb2xpZGF0aW9uIG9yIHNhbGUgb2YgYWxsIG9yIHN1YnN0YW50aWFsbHkgYWxsIG9mIHRoZQphc3NldHMgb2Ygc3VjaCBQYXJ0eSByZWxhdGluZyB0byB0aGUgc3ViamVjdCBtYXR0ZXIgb2YgdGhpcyBBZ3JlZW1lbnQuCldhaXZlcuKAiy4gVGhlIHdhaXZlciBieSBlaXRoZXIgUGFydHkgb2YgYSBicmVhY2gsIGRlZmF1bHQsIGRlbGF5IG9yIG9taXNzaW9uIG9mIGFueSBvZiB0aGUKcHJvdmlzaW9ucyBvZiB0aGlzIEFncmVlbWVudCBieSB0aGUgb3RoZXIgUGFydHkgd2lsbCBub3QgYmUgY29uc3RydWVkIGFzIGEgd2FpdmVyIG9mIGFueQpzdWJzZXF1ZW50IGJyZWFjaCBvZiB0aGUgc2FtZSBvciBvdGhlciBwcm92aXNpb25zLgpFbnRpcmUgQWdyZWVtZW504oCLLiBUaGlzIEFncmVlbWVudCwgaW5jbHVkaW5nIGFsbCBkb2N1bWVudHMgaW5jb3Jwb3JhdGVkIGludG8gdGhpcwpBZ3JlZW1lbnQgYnkgcmVmZXJlbmNlLCBjb25zdGl0dXRlcyB0aGUgZW50aXJlIGFncmVlbWVudCBvZiB0aGUgUGFydGllcyB3aXRoIHJlc3BlY3QgdG8KdGhlIHN1YmplY3QgbWF0dGVyIG9mIHRoaXMgQWdyZWVtZW50LCBhbmQgc3VwZXJzZWRlcyBhbnkgYW5kIGFsbCBwcmlvciBhZ3JlZW1lbnRzIGFuZAp1bmRlcnN0YW5kaW5ncyBvZiB0aGUgUGFydGllcywgd2hldGhlciB3cml0dGVuIG9yIG9yYWwsIHdpdGggcmVzcGVjdCB0byBzdWNoIHN1YmplY3QKbWF0dGVyLgpNb2RpZmljYXRpb24gb2YgVGhpcyBBZ3JlZW1lbnTigIsuIFNvdnJpbiBGb3VuZGF0aW9uIHJlc2VydmVzIHRoZSByaWdodCB0byBtb2RpZnkgdGhpcwpBZ3JlZW1lbnQgYXQgYW55IHRpbWUgaW4gYWNjb3JkYW5jZSB3aXRoIHRoaXMgcHJvdmlzaW9uLCBpbmNsdWRpbmcsIGJ1dCBub3QgbGltaXRlZCB0bywKY2hhbmdlcyBpbiBhcHBsaWNhYmxlIGxhdyBvciBndWlkYW5jZSBmcm9tIGFueSBqdXJpc2RpY3Rpb24uIFNvdnJpbiBGb3VuZGF0aW9uIHdpbGwgcG9zdAphbiBhbWVuZGVkIHZlcnNpb24gb2YgdGhpcyBBZ3JlZW1lbnQgb24gaXRzIHdlYnNpdGUgYXQgbGVhc3QgbmluZXR5ICg5MCkgZGF5cyBwcmlvciB0bwp0aGUgZWZmZWN0aXZlIGRhdGUgb2YgdGhlIGFtZW5kbWVudCAodGhlIOKAnEFtZW5kbWVudCBFZmZlY3RpdmUgRGF0ZeKAnSkuIElmIFRyYW5zYWN0aW9uCkF1dGhvciBjb250aW51ZXMgdG8gQXV0aG9yIFRyYW5zYWN0aW9ucyB0byB0aGUgU292cmluIExlZGdlciBhZnRlciB0aGUgQW1lbmRtZW50CkVmZmVjdGl2ZSBEYXRlLCBzdWNoIGNvbnRpbnVlZCB1c2Ugd2lsbCBjb25zdGl0dXRlIGFjY2VwdGFuY2Ugb2YgdGhlIGFtZW5kZWQKQWdyZWVtZW50LgpDb3VudGVycGFydHPigIsuIFRoaXMgQWdyZWVtZW50IG1heSBiZSBleGVjdXRlZCBpbiB0d28gb3IgbW9yZSBjb3VudGVycGFydHMsIGVhY2ggb2YKd2hpY2ggd2lsbCBiZSBkZWVtZWQgYW4gb3JpZ2luYWwsIGJ1dCBhbGwgb2Ygd2hpY2ggdGFrZW4gdG9nZXRoZXIgd2lsbCBjb25zdGl0dXRlIG9uZSBhbmQKdGhlIHNhbWUgaW5zdHJ1bWVudApTdXJ2aXZhbOKAiy4gQW55IHRlcm1zIHRoYXQgYnkgdGhlaXIgbmF0dXJlIHN1cnZpdmUgdGVybWluYXRpb24gb3IgZXhwaXJhdGlvbiBvZiB0aGlzCkFncmVlbWVudCBzaGFsbCBzdXJ2aXZlLgoKDDgpIFNpZ25hdHVyZXMKVGhlIFBhcnRpZXMgaGVyZXRvIGhhdmUgY2F1c2VkIHRoaXMgQWdyZWVtZW50IHRvIGJlIGV4ZWN1dGVkIGJ5IHRoZWlyIGR1bHkgYXV0aG9yaXplZApyZXByZXNlbnRhdGl2ZXMgYXMgb2YgdGhlIEVmZmVjdGl2ZSBEYXRlLgoKU292cmluIEZvdW5kYXRpb24KQnk6CgpfX19fX19fX19fX19fX19fX19fX19fX18KCk5hbWU6CgpfX19fX19fX19fX19fX19fX19fX18KClRpdGxlOgoKX19fX19fX19fX19fX19fX19fX19fXwoKRGF0ZToKCl9fX19fX19fX19fX19fX19fX19fX18KClRyYW5zYWN0aW9uIEF1dGhvcgpCeToKCl9fX19fX19fX19fX19fX19fX19fX19fXwoKTmFtZToKCl9fX19fX19fX19fX19fX19fX19fXwoKVGl0bGU6CgpfX19fX19fX19fX19fX19fX19fX19fCgpEYXRlOgoKX19fX19fX19fX19fX19fX19fX19fXwoKSW4gdGhlIHByZXNlbmNlIG9mOgpOYW1lOgoKX19fX19fX19fX19fX19fX19fX19fCgpUaXRsZToKCl9fX19fX19fX19fX19fX19fX19fX18KCkFkZHJlc3M6IF9fX19fX19fX19fX19fX19fX19fX18KCjgKCgw="), "UTF-8");
		} catch (Exception ex) {

			throw new RuntimeException(ex.getMessage(), ex);
		}
	}


	public static String agree(String request, String taa) throws InterruptedException, ExecutionException, IndyException {

		// agree

		String taaVersion = taaVersion();
		String taaDigest = taaDigest(taaVersion + taa);
		String taaMechanism = taaMechanism();

		log.info("taa: " + taa);
		log.info("taaVersion: " + taaVersion);
		log.info("taaDigest: " + taaDigest);
		log.info("taaMechanism: " + taaMechanism);

		String appendTxnAuthorAgreementAcceptanceToNymRequest = Ledger.appendTxnAuthorAgreementAcceptanceToRequest(request, Taa.taa, taaVersion, taaDigest, taaMechanism, System.currentTimeMillis()/1000).get();

		return appendTxnAuthorAgreementAcceptanceToNymRequest;
	}

	static String taaVersion() {

		return "1";
	}

	static String taaDigest(String taa) {

		MessageDigest md;

		try {

			md = MessageDigest.getInstance("SHA-256");
		} catch (NoSuchAlgorithmException ex) {

			throw new RuntimeException(ex.getMessage(), ex);
		}

		byte[] digest = md.digest(taa.getBytes(StandardCharsets.UTF_8));
		String taaDigest = Hex.encodeHexString(digest);
		if (log.isDebugEnabled()) log.debug("taaDigest: " + taaDigest);

		return taaDigest;
	}

	static String taaMechanism() {

		return "for_session";
	}
}
